# Database Schema and Data Import

## Overview

This document outlines the database schema, data import processes, and BigQuery integration for the Autobet project. The primary database is a SQLite database, with data being periodically exported to Google BigQuery for more advanced analysis.

## Local Database Schema

The local database schema is defined in `sports/schema.py`. It is a SQLite database, and the schema is created and managed using standard SQL `CREATE TABLE` statements.
 
### Core Sporting Tables
 
*   **`teams`**: Stores team names and their unique IDs.
*   **`matches`**: Contains information about individual matches, including sport, competition, season, date, teams, and results.
*   **`odds`**: Stores odds for various matches from different bookmakers.
*   **`suggestions`**: Contains betting suggestions generated by the system's models.
*   **`subscriptions`**: Manages user subscriptions for notifications.

### Horse Racing Tables

*   **`hr_meetings`**: Information about horse racing meetings.
*   **`hr_races`**: Details of individual races within a meeting.
*   **`hr_runners`**: Information about the runners in each race.
*   **`hr_pools`**: Tote pool information for races.
*   **`hr_pool_dividends`**: Dividend information for Tote pools.
*   **`hr_bets`**: Records of bets placed.
*   **`hr_horses`**: Master list of horses.
*   **`hr_horse_runs`**: Performance data for individual horses.
*   **`race_conditions`**: Information about race conditions (e.g., weather, going).
*   **`geo_venues`**: Geolocation data for venues.

### Tote Data Tables

*   **`raw_tote`**: Stores raw payloads from the Tote API for debugging and fidelity.
*   **`tote_events`**: Generic Tote events for various sports.
*   **`tote_products`**: Information about Tote betting products (e.g., Superfecta).
*   **`tote_product_dividends`**: Dividend information for Tote products.
*   **`tote_product_selections`**: Selections for each leg of a Tote product.
*   **`tote_bets`**: Records of Tote bets placed.
*   **`tote_pool_snapshots`**: Time-series snapshots of Tote pool totals.
*   **`tote_event_competitors_log`**: Logs of competitor changes for events.
*   **`tote_messages`**: Raw Tote subscription messages.
*   **`hr_runner_info`**: Additional runner information (e.g., weights, ratings).

### Modeling and Features Tables

*   **`features_runner_event`**: Features for runners in specific events, used for modeling.
*   **`models`**: Information about trained models.
*   **`predictions`**: Predictions generated by the models.
*   **`superfecta_eval`**: Evaluation of Superfecta predictions against actual results.

## Data Imports

Data is imported from various sources using scripts located in the `sports/ingest/` directory. Each script is responsible for fetching data from a specific source and inserting it into the appropriate database tables.

### Data Sources

*   **Tote (`tote_events.py`, `tote_horse.py`, `tote_products.py`, `tote_results.py`)**: Ingests a wide range of betting data from the Tote API.
*   **Weather (`weather.py`)**: Imports weather data.
*   **Kaggle (`hr_kaggle_results.py`)**: Imports historical horse racing data from Kaggle datasets.

## BigQuery Integration

For more advanced analysis and to handle larger datasets, data is periodically exported to Google BigQuery.

### Setup

The BigQuery integration is configured via the following environment variables:

*   `BQ_WRITE_ENABLED`: Set to `true` to enable writing to BigQuery.
*   `BQ_PROJECT`: The Google Cloud project ID.
*   `BQ_DATASET`: The BigQuery dataset to use.
*   `BQ_LOCATION`: The location of the BigQuery dataset (e.g., `EU`).

The core logic for the BigQuery integration is in `sports/bq.py`. The `BigQuerySink` class handles the creation of tables and the upserting of data.

### Synced Tables

The following tables are synced to BigQuery:

*   `tote_products`
*   `tote_product_dividends`
*   `tote_events`
*   `tote_event_competitors_log`
*   `raw_tote`
*   `tote_product_selections`
*   `tote_pool_snapshots`
*   `hr_horse_runs`
*   `hr_horses`
*   `race_conditions`
*   `models`
*   `predictions`
*   `features_runner_event`
*   `odds_live`

### BigQuery Views

A number of views are created in BigQuery to facilitate analysis. These views are defined in `sports/bq.py` in the `ensure_views` method.

*   **`vw_horse_runs_by_name`**: Joins horse runs with horse names and event context.
*   **`vw_today_gb_events`**: Shows today's Great Britain events with a competitor count.
*   **`vw_today_gb_superfecta`**: Displays today's Great Britain Superfecta products with pool totals and competitor counts.
*   **`vw_today_gb_superfecta_latest`**: Provides the latest pool snapshot for each Superfecta product for today's GB races.
*   **`vw_today_gb_superfecta_be`**: Calculates breakeven metrics for today's GB Superfecta pools.
*   **`vw_gb_open_superfecta_next60`**: Lists open GB Superfecta products starting in the next 60 minutes.
*   **`vw_gb_open_superfecta_next60_be`**: Calculates breakeven metrics for open GB Superfecta products starting in the next 60 minutes.
*   **`vw_superfecta_products`**: A convenient filter of the `tote_products` table for Superfecta bets.
*   **`vw_superfecta_dividends_latest`**: Shows the latest dividend for each selection for each Superfecta product.
*   **`vw_runner_features`**: Joins runner features with horse names.
*   **`vw_superfecta_training`**: Combines product and event context with runner results for model training.

{% extends 'base.html' %}
{% block title %}Audit Bet Detail{% endblock %}
{% block content %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Audit Bet</strong>
    {% if bet %}
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('audit_bet_detail_page', bet_id=bet.bet_id) }}?refresh=1">Refresh Status</a>
    {% endif %}
  </div>
  <div class="card-body">
    {% if not bet %}
      <em>Unknown bet.</em>
    {% else %}
      <div class="mb-2"><b>Bet ID:</b> {{ bet.bet_id }}</div>
      <div class="mb-2"><b>Time:</b> {% if bet._created_iso %}<span class="time-iso" data-iso="{{ bet._created_iso }}">{{ bet._created_iso }}</span>{% else %}—{% endif %}</div>
      <div class="mb-2"><b>Product:</b> <code>{{ bet.product_id }}</code></div>
      <div class="mb-2"><b>Selection(s):</b> {{ bet.selection }}</div>
      <div class="mb-2"><b>Stake:</b> {{ '%.2f' % bet.stake }} {{ bet.currency }}</div>
      <div class="mb-2"><b>Status:</b> {{ bet.status }} | <b>Outcome:</b> {{ bet.outcome or '' }}</div>
      <hr>
      <h6>Try Again (Audit)</h6>
      <form method="post" action="{{ url_for('tote_audit_superfecta_post') }}" class="row row-cols-lg-auto g-2 align-items-center">
        <input type="hidden" name="product_id" value="{{ bet.product_id }}" />
        <div class="col-12 col-lg-4">
          <label class="form-label">Selection(s)</label>
          <input class="form-control" name="selection" value="{{ bet.selection }}" />
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">Stake (£)</label>
          <input class="form-control" type="number" step="0.01" min="0" name="stake" value="{{ '%.2f' % bet.stake }}" />
          <div class="small mt-1">
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="event.preventDefault(); this.closest('form').querySelector('[name=stake]').value = (parseFloat(this.closest('form').querySelector('[name=stake]').value)||0 + 0.5).toFixed(2);">+0.50</button>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="event.preventDefault(); this.closest('form').querySelector('[name=stake]').value = (parseFloat(this.closest('form').querySelector('[name=stake]').value)||0 + 1.0).toFixed(2);">+1.00</button>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">Currency</label>
          <input class="form-control" name="currency" value="{{ bet.currency or 'GBP' }}" />
        </div>
        <div class="col-12 col-lg-2">
          <label class="form-label">Stake Type</label>
          <select class="form-select" name="stake_type">
            <option value="total" selected>Total</option>
            <option value="line">Line</option>
          </select>
        </div>
        <input type="hidden" name="post" value="on" />
        <div class="col-12 col-lg-2 align-self-end">
          <button class="btn btn-primary">Try Again</button>
        </div>
      </form>
      <hr>
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="m-0">Request JSON</h6>
        <button class="btn btn-sm btn-outline-secondary" id="btnCopyReq">Copy</button>
      </div>
      <pre id="preReq" style="white-space:pre-wrap; font-family:monospace;">{{ bet._req_pretty or '' }}</pre>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <h6 class="m-0">Response JSON</h6>
        <button class="btn btn-sm btn-outline-secondary" id="btnCopyResp">Copy</button>
      </div>
      <pre id="preResp" style="white-space:pre-wrap; font-family:monospace;">{{ bet._resp_pretty or bet.response_json }}</pre>
      {% if bet.result_json %}
      <h6>Result JSON</h6>
      <pre style="white-space:pre-wrap; font-family:monospace;">{{ bet.result_json }}</pre>
      {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  function copyPre(id){
    const el = document.getElementById(id);
    if(!el) return;
    const txt = el.innerText || el.textContent || '';
    if(!navigator.clipboard){
      const ta = document.createElement('textarea');
      ta.value = txt; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); }catch(e){}
      document.body.removeChild(ta);
      return;
    }
    navigator.clipboard.writeText(txt).catch(()=>{});
  }
  const btnReq = document.getElementById('btnCopyReq');
  if(btnReq){ btnReq.addEventListener('click', function(){ copyPre('preReq'); }); }
  const btnResp = document.getElementById('btnCopyResp');
  if(btnResp){ btnResp.addEventListener('click', function(){ copyPre('preResp'); }); }
})();
</script>
{% endblock %}

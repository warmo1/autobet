{% extends 'base.html' %}
{% block content %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Event</strong>
    <div>
      <button class="btn btn-sm btn-outline-primary me-2" id="btn-refresh-pools" data-eid="{{ event.event_id }}">Refresh Pools</button>
      <button class="btn btn-sm btn-outline-primary me-2" id="btn-refresh-odds" data-eid="{{ event.event_id }}">Refresh Odds</button>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('tote_events_page') }}">Back</a>
    </div>
  </div>
  <div class="card-body">
    <div class="mb-2">
      <div><strong>{{ event.name }}</strong></div>
      <div class="small text-muted">{{ event.venue }} • {{ event.country }} • <span class="time-iso" data-iso="{{ event.start_iso }}">{{ event.start_iso }}</span> • Sport: {{ event.sport or '—' }} • Status: {{ event.status }}</div>
      {% if conditions %}
        <div class="mt-1 small">
          <span class="badge bg-light text-dark">Going: {{ conditions.going or '—' }}</span>
          <span class="badge bg-light text-dark ms-1">Temp: {{ conditions.weather_temp_c is not none and (conditions.weather_temp_c | round(0) | int) ~ '°C' or '—' }}</span>
          <span class="badge bg-light text-dark ms-1">Wind: {{ conditions.weather_wind_kph is not none and (conditions.weather_wind_kph | round(0) | int) ~ ' kph' or '—' }}</span>
          <span class="badge bg-light text-dark ms-1">Precip: {{ conditions.weather_precip_mm is not none and (conditions.weather_precip_mm | round(1)) ~ ' mm' or '—' }}</span>
        </div>
      {% endif %}
    </div>

    {% if event.sport == 'football' %}
      <div class="mb-3">
        <strong>Match</strong>
        <div>{{ event.home or 'Home' }} vs {{ event.away or 'Away' }}</div>
      </div>
    {% else %}
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <strong>Runners</strong>
          <small class="text-muted">Shows latest Probable Odds when available</small>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>#</th><th>Horse</th><th>Probable (dec)</th><th>Updated</th></tr></thead>
            <tbody>
            {% set rows = runners_prob if runners_prob is defined and runners_prob else [] %}
            {% if not rows and runners %}
              {% for r in runners %}
              <tr><td>{{ r.cloth }}</td><td>{{ r.name }}</td><td>—</td><td>—</td></tr>
              {% endfor %}
            {% else %}
              {% for r in rows %}
              <tr>
                <td>{{ r.cloth_number if r.cloth_number is not none else (r.cloth or '—') }}</td>
                <td>{{ r.horse or r.selection_id }}</td>
                <td>{% if r.decimal_odds is not none and r.decimal_odds > 0 %}{{ '%.2f' % r.decimal_odds }}{% else %}—{% endif %}</td>
                <td>{% if r.odds_iso %}<span class="time-iso" data-iso="{{ r.odds_iso }}">{{ r.odds_iso }}</span>{% else %}—{% endif %}</td>
              </tr>
              {% endfor %}
            {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    {% if products %}
      <div class="mb-2"><strong>Pools</strong> <span class="small text-muted">Gross: total funds • Net: after takeout • Rollover: carried in • Takeout: operator fee</span></div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead><tr><th>Bet</th><th>Status</th><th class="text-end">Gross</th><th class="text-end">Net</th><th class="text-end">Rollover</th><th class="text-end">Takeout</th><th>Product</th></tr></thead>
          <tbody>
            {% for p in products %}
              <tr>
                <td>{{ p.bet_type }}</td>
                <td>{{ p.status }}</td>
                <td class="text-end">{{ p.total_gross | f2 }}</td>
                <td class="text-end">{{ p.total_net | f2 }}</td>
                <td class="text-end">{{ p.rollover | f2 }}</td>
                <td class="text-end">{{ p.deduction_rate_display }}</td>
                <td class="text-truncate" style="max-width:320px;">{{ p.product_id }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    {% if features %}
      <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <strong>Runner Features</strong>
          <small class="text-muted">{{ features|length }} rows</small>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Horse</th>
                <th>Recent</th>
                <th>Avg Fin</th>
                <th>W L5</th>
                <th>P L5</th>
                <th>Days Since</th>
                <th>Temp °C</th>
                <th>Wind kph</th>
                <th>Precip mm</th>
                <th>Going</th>
              </tr>
            </thead>
            <tbody>
              {% for f in features %}
              <tr>
                <td>{{ f.cloth_number if f.cloth_number is not none else '—' }}</td>
                <td>{{ f.horse_name or f.horse_id }}</td>
                <td>{{ f.recent_runs if f.recent_runs is not none else '—' }}</td>
                <td>{{ '%.2f' % f.avg_finish if f.avg_finish is not none else '—' }}</td>
                <td>{{ f.wins_last5 if f.wins_last5 is not none else '—' }}</td>
                <td>{{ f.places_last5 if f.places_last5 is not none else '—' }}</td>
                <td>{{ f.days_since_last_run if f.days_since_last_run is not none else '—' }}</td>
                <td>{{ '%.0f' % f.weather_temp_c if f.weather_temp_c is not none else '—' }}</td>
                <td>{{ '%.0f' % f.weather_wind_kph if f.weather_wind_kph is not none else '—' }}</td>
                <td>{{ '%.1f' % f.weather_precip_mm if f.weather_precip_mm is not none else '—' }}</td>
                <td>{{ f.going or '—' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    {% if runner_rows %}
      <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <strong>Runners (HR database)</strong>
          <small class="text-muted">{{ runner_rows|length }} runners</small>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Horse</th>
                <th>Finish</th>
                <th>Status</th>
                <th>Jockey</th>
                <th>Trainer</th>
              </tr>
            </thead>
            <tbody>
              {% for r in runner_rows %}
                <tr>
                  <td>{{ r.cloth_number if r.cloth_number is not none else '—' }}</td>
                  <td>{{ r.horse_name or r.horse_id }}</td>
                  <td>{{ r.finish_pos if r.finish_pos is not none else '—' }}</td>
                  <td>{{ r.status or '—' }}</td>
                  <td>{{ r.jockey or '—' }}</td>
                  <td>{{ r.trainer or '—' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Live status updates for this event
  try {
    const eid = "{{ event.event_id }}";
    if (eid) {
      const qs = new URLSearchParams({ topics: 'event_status_changed,product_status_changed', events: eid });
      const es = new EventSource(`/stream?${qs.toString()}`);
      const setHeaderStatus = function(status){
        try {
          const small = document.querySelector('.card-body .small.text-muted');
          if (!small) return;
          // Replace the trailing "Status: ..." part
          const txt = small.textContent || '';
          const parts = txt.split('•');
          for (let i=0;i<parts.length;i++){
            if (parts[i].trim().toUpperCase().startsWith('STATUS:')){
              parts[i] = ` Status: ${status}`;
              break;
            }
          }
          small.textContent = parts.join(' • ');
        } catch (e) {}
      };
      es.addEventListener('event_status_changed', function(ev){
        try{ const d = JSON.parse(ev.data); if (d && d.status !== undefined) setHeaderStatus(d.status); }catch(e){}
      });
      es.addEventListener('product_status_changed', function(ev){
        try{
          const d = JSON.parse(ev.data);
          const st = String(d.status || '').toUpperCase();
          if (st === 'OPEN') setHeaderStatus('OPEN');
          if (st === 'CLOSED' && String(d.bet_type || '').toUpperCase() === 'WIN') setHeaderStatus('CLOSED');
        }catch(e){}
      });
      es.onerror = function(){};
    }
  } catch (e) {}

  const btn = document.getElementById('btn-refresh-pools');
  if (!btn) return;
  btn.addEventListener('click', async () => {
    try {
      btn.disabled = true; btn.textContent = 'Refreshing...';
      const eid = btn.getAttribute('data-eid');
      const res = await fetch(`/api/tote/refresh_event_pools/${eid}`, { method: 'POST' });
      const j = await res.json().catch(()=>({}));
      btn.textContent = 'Refreshed';
      setTimeout(()=>window.location.reload(), 800);
    } catch (e) {
      console.error('refresh pools', e);
      btn.textContent = 'Error'; btn.disabled = false;
    }
  });
  const btnOdds = document.getElementById('btn-refresh-odds');
  if (btnOdds) {
    btnOdds.addEventListener('click', async () => {
      try {
        btnOdds.disabled = true; btnOdds.textContent = 'Refreshing...';
        const eid = btnOdds.getAttribute('data-eid');
        const res = await fetch(`/api/tote/refresh_odds/${eid}`, { method: 'POST' });
        const j = await res.json().catch(()=>({}));
        btnOdds.textContent = 'Refreshed';
        setTimeout(()=>window.location.reload(), 800);
      } catch (e) {
        console.error('refresh odds', e);
        btnOdds.textContent = 'Error'; btnOdds.disabled = false;
      }
    });
  }
});
</script>
{% endblock %}

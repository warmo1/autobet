{% extends "base.html" %} {# This is now the main dashboard #}

{% block title %}Ingestion Status{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/status.css') }}">
<script src="{{ url_for('static', filename='js/status.js') }}" defer></script>
{% endblock %}

{% block content %}
<h1>Autobet Dashboard</h1>

<div id="status-grid" class="status-grid">

    <div class="status-card">
        <h2>Data Freshness</h2>
        <div class="cards-grid" id="data-freshness-list">
            <div class="mini-card" id="card-events">
                <div class="mini-title">Events Today</div>
                <div class="mini-value" id="events-today">...</div>
                <div class="mini-meta">Last ingest: <span class="time-ago" id="events-last-fetch">...</span></div>
            </div>
            <div class="mini-card" id="card-products">
                <div class="mini-title">Products Today</div>
                <div class="mini-value" id="products-today">...</div>
                <div class="mini-meta">Last ingest: <span class="time-ago" id="products-last-fetch">...</span></div>
            </div>
            <div class="mini-card" id="card-odds">
                <div class="mini-title">Probable Odds Today</div>
                <div class="mini-value" id="odds-today">...</div>
                <div class="mini-meta">Last ingest: <span class="time-ago" id="odds-last-fetch">...</span></div>
            </div>
            <div class="mini-card" id="card-pools">
                <div class="mini-title">Pool Snapshots Today</div>
                <div class="mini-value" id="pools-today">...</div>
                <div class="mini-meta">Last ingest: <span class="time-ago" id="pools-last-fetch">...</span></div>
            </div>
        </div>
    </div>

    <div class="status-card">
        <h2>Upcoming Races (Next 60 mins)</h2>
        <div id="upcoming-races-list" style="max-height: 200px; overflow-y: auto;">
            <!-- Populated by JS -->
            <div class="small text-muted p-2">Loading...</div>
        </div>
    </div>

    <div class="status-card">
        <h2>Quick Actions</h2>
        <div class="quick-actions">
            <div class="qa-row">
                <button class="btn" data-action="events_today">Ingest Events Today</button>
                <button class="btn" data-action="products_today_open">Ingest Products Today (OPEN)</button>
            </div>
            <div class="qa-row">
                <input type="date" id="qa-date" class="qa-input" value="{{ now_iso_date }}" />
                <button class="btn" data-action="events_for_date" data-src="#qa-date">Ingest Events (date)</button>
                <button class="btn" data-action="products_for_date_open" data-src="#qa-date">Ingest Products (date, OPEN)</button>
            </div>
            <div class="qa-row">
                <input type="text" id="qa-event-id" placeholder="Event ID" class="qa-input" />
                <button class="btn" data-action="probable_odds_event" data-src="#qa-event-id">Probable Odds</button>
            </div>
            <div class="qa-row">
                <input type="text" id="qa-product-id" placeholder="Product ID" class="qa-input" />
                <button class="btn" data-action="single_product" data-src="#qa-product-id">Product Pool</button>
            </div>
            <div class="qa-note small text-muted" id="qa-result"></div>
        </div>
    </div>

    <div class="status-card" style="grid-column: 1 / -1;">
        <h2>Recent Ingestion Jobs</h2>
        <div id="job-log-list" style="max-height: 300px; overflow-y: auto;">
            <table class="job-log-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Task</th>
                        <th>Started</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="job-log-body">
                    <!-- Populated by JS -->
                    <tr><td colspan="4" class="text-center text-muted small">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="status-card" style="grid-column: 1 / -1;">
        <h2>GCP Deployments</h2>
        <div id="gcp-meta" class="mb-2 small text-muted"></div>

        <div class="gcp-section">
            <h3>Cloud Run Services</h3>
            <table class="status-table" id="cloudrun-table">
                <thead>
                    <tr><th>Name</th><th>Ready</th><th>URI</th><th>Updated</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="gcp-section">
            <h3>Cloud Scheduler Jobs</h3>
            <table class="status-table" id="scheduler-table">
                <thead>
                    <tr><th>Name</th><th>State</th><th>Schedule</th><th>Last Attempt</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="gcp-section">
            <h3>Pub/Sub</h3>
            <table class="status-table" id="pubsub-table">
                <thead>
                    <tr><th>Resource</th><th>Exists</th><th>Detail</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

{% endblock %}

{% extends 'base.html' %}
{% block title %}Place a Bet{% endblock %}

{% block content %}
<div class="container mt-3">

    <h1>Place a Bet</h1>
    <p class="text-muted">Select an event and product to place a single-line bet in either Audit or Live mode.</p>

    <form method="GET" action="{{ url_for('tote_bet_page') }}" class="mb-4 p-3 border rounded bg-light">
        <div class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
                <label for="country" class="form-label">Country</label>
                <select name="country" id="country" class="form-select">
                    <option value="">All</option>
                    {% for c in country_options or [] %}
                    <option value="{{ c }}" {% if filters.country == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-6">
                <label for="venue" class="form-label">Venue</label>
                <input type="text" name="venue" id="venue" class="form-control" value="{{ filters.venue }}" placeholder="e.g. Ascot">
            </div>
            <div class="col-12 col-md-3">
                <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
        </div>
    </form>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="card">
        <div class="card-header">
            <h4>Bet Slip</h4>
        </div>
        <div class="card-body">
            <form method="POST" id="bet-form" action="{{ url_for('tote_bet_page') }}">
                <div class="form-check form-switch mb-3 p-3 border rounded bg-light">
                    <input class="form-check-input" type="checkbox" id="betModeSwitch" name="mode" value="live">
                    <label class="form-check-label" for="betModeSwitch">
                        <strong>Enable LIVE Betting Mode</strong> (Default is Audit). Live bets may affect real funds.
                    </label>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="event_id" class="form-label">Event</label>
                        <select class="form-select" id="event_id" name="event_id" required>
                            <option value="" selected disabled>-- Select an Event --</option>
                            {% for event in events %}
                                <option value="{{ event.event_id }}">{{ event.start_iso[:16] }} | {{ event.venue }} | {{ event.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="product_id" class="form-label">Bet Type (Product)</label>
                        <select class="form-select" id="product_id" name="product_id" required disabled>
                            <option value="" selected disabled>-- Select an event first --</option>
                        </select>
                    </div>
                    <div class="col-md-6" id="simple-section">
                        <label for="selection_id" class="form-label">Runner / Selection</label>
                        <select class="form-select" id="selection_id" name="selection_id" required disabled>
                            <option value="" selected disabled>-- Select a product first --</option>
                        </select>
                    </div>
                    <div class="col-12 d-none" id="sf-section">
                        <label for="selections_text" class="form-label">Selections (one per line, e.g., 3-7-1-5)</label>
                        <textarea class="form-control" id="selections_text" name="selections_text" rows="4" placeholder="3-7-1-5\n1-2-3-4"></textarea>
                        <small class="text-muted">For combination bets (EXACTA/TRIFECTA/SUPERFECTA), enter ordered finish positions separated by dashes.</small>
                    </div>
                    <div class="col-md-3">
                        <label for="stake" class="form-label">Stake</label>
                        <div class="input-group">
                            <span class="input-group-text">Â£</span>
                            <input type="number" step="0.01" class="form-control" id="stake" name="stake" min="0.01" required>
                        </div>
                    </div>
                     <div class="col-md-3">
                        <label for="currency" class="form-label">Currency</label>
                        <input type="text" class="form-control" id="currency" name="currency" value="GBP" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-4">Place Bet</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventSelect = document.getElementById('event_id');
    const productSelect = document.getElementById('product_id');
    const selectionSelect = document.getElementById('selection_id');
    const PRESELECT = {{ preselect | tojson if preselect else 'null' }};

    eventSelect.addEventListener('change', function() {
        const eventId = this.value;
        productSelect.disabled = true;
        productSelect.innerHTML = '<option>Loading...</option>';
        selectionSelect.disabled = true;
        selectionSelect.innerHTML = '<option>-- Select a product first --</option>';
        if (!eventId) return;
        fetch(`/api/tote/event_products/${eventId}`).then(r => r.json()).then(data => {
            productSelect.innerHTML = '<option value="" selected disabled>-- Select a Bet Type --</option>';
            data.forEach(p => {
                const opt = new Option(`${p.bet_type} (${p.status})`, p.product_id);
                opt.dataset.bt = (p.bet_type || '').toUpperCase();
                productSelect.add(opt);
            });
            productSelect.disabled = false;
            // If we have a preselect product for this event, set it and trigger change
            if (PRESELECT && PRESELECT.product_id) {
                const opt = Array.from(productSelect.options).find(o => o.value === PRESELECT.product_id);
                if (opt) {
                    productSelect.value = PRESELECT.product_id;
                    productSelect.dispatchEvent(new Event('change'));
                }
            }
        });
    });

    productSelect.addEventListener('change', function() {
        const productId = this.value;
        const selectedOpt = this.options[this.selectedIndex];
        const bt = (selectedOpt && selectedOpt.dataset.bt) ? selectedOpt.dataset.bt : '';
        const isCombo = ['EXACTA','TRIFECTA','SUPERFECTA'].includes(bt);
        // Toggle UI sections
        document.getElementById('sf-section').classList.toggle('d-none', !isCombo);
        document.getElementById('simple-section').classList.toggle('d-none', isCombo);
        selectionSelect.disabled = true;
        selectionSelect.innerHTML = '<option>Loading...</option>';
        if (!productId) return;
        if (!isCombo) {
            fetch(`/api/tote/product_runners?product_id=${productId}`).then(r => r.json()).then(data => {
                selectionSelect.innerHTML = '<option value="" selected disabled>-- Select a Runner --</option>';
                data.forEach(r => selectionSelect.add(new Option(`#${r.number} - ${r.competitor}`, r.selection_id)));
                selectionSelect.disabled = false;
            });
        }
    });
    // If preselect is provided, set event and trigger load
    if (PRESELECT && PRESELECT.event_id) {
        const evOpt = Array.from(eventSelect.options).find(o => o.value === PRESELECT.event_id);
        if (evOpt) {
            eventSelect.value = PRESELECT.event_id;
            eventSelect.dispatchEvent(new Event('change'));
        }
    }
});
</script>

{% endblock %}

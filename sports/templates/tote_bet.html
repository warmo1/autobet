{% extends 'base.html' %}
{% block title %}Audit Bet{% endblock %}
{% block content %}
<div class="container mt-3">
  <h3>Audit Bet (Single Selection)</h3>
  <p class="text-muted">Places an audit bet via the Tote API and records it in BigQuery. No real funds are used.</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" class="card">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="event_id" class="form-label">Event</label>
          <select id="event_id" class="form-select" required>
            <option value="">Select an event…</option>
            {% for e in events %}
              <option value="{{ e.event_id }}">{{ e.name }} — {{ e.venue }} — {{ e.start_iso }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Populates open products and selections.</div>
        </div>
        <div class="col-md-3">
          <label for="product_id" class="form-label">Product</label>
          <select id="product_id" name="product_id" class="form-select" required>
            <option value="">Select a product…</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="selection_id" class="form-label">Selection (Runner)</label>
          <select id="selection_id" name="selection_id" class="form-select" required>
            <option value="">Select a runner…</option>
          </select>
        </div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-md-3">
          <label for="stake" class="form-label">Stake</label>
          <input type="number" step="0.01" min="0.01" id="stake" name="stake" class="form-control" placeholder="e.g. 2.00" required>
        </div>
        <div class="col-md-2">
          <label for="currency" class="form-label">Currency</label>
          <select id="currency" name="currency" class="form-select">
            <option value="GBP" selected>GBP</option>
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
          </select>
        </div>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Place Audit Bet</button>
        <a href="{{ url_for('tote_events_page') }}" class="btn btn-secondary ms-2">Back to Events</a>
      </div>
    </div>
  </form>

  <div class="card mt-3">
    <div class="card-header"><strong>Notes</strong></div>
    <div class="card-body">
      <ul class="small text-muted mb-0">
        <li>Products are restricted to OPEN pools. Selections match the chosen product.</li>
        <li>This page records audit bets to BigQuery (`tote_audit_bets`) and posts to the Tote API.</li>
        <li>Use the Audit Bets pages to review outcomes after settlement.</li>
      </ul>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const eventSel = document.getElementById('event_id');
  const productSel = document.getElementById('product_id');
  const selectionSel = document.getElementById('selection_id');

  async function fetchJSON(url){
    try{ const r = await fetch(url); if(!r.ok) return null; return await r.json(); }catch(e){ return null; }
  }

  async function onEventChange(){
    selectionSel.innerHTML = '<option value="">Select a runner…</option>';
    productSel.innerHTML = '<option value="">Select a product…</option>';
    const eid = eventSel.value;
    if(!eid) return;
    const data = await fetchJSON(`/api/tote/event_products/${eid}`);
    const nodes = (data && data.products) || [];
    // Prefer WIN first
    nodes.sort((a,b) => (a.bet_type==='WIN'? -1 : 0) - (b.bet_type==='WIN'? -1 : 0));
    for(const p of nodes){
      const opt = document.createElement('option');
      opt.value = p.product_id; opt.textContent = `${p.bet_type} — ${p.status}`;
      productSel.appendChild(opt);
    }
  }

  async function onProductChange(){
    selectionSel.innerHTML = '<option value="">Select a runner…</option>';
    const pid = productSel.value; if(!pid) return;
    const data = await fetchJSON(`/api/tote/product_selections/${pid}`);
    const sels = (data && data.selections) || [];
    for(const s of sels){
      const opt = document.createElement('option');
      const cloth = s.number != null ? `#${s.number} ` : '';
      opt.value = s.selection_id; opt.textContent = `${cloth}${s.competitor || s.selection_id}`;
      selectionSel.appendChild(opt);
    }
  }

  eventSel.addEventListener('change', onEventChange);
  productSel.addEventListener('change', onProductChange);
});
</script>
{% endblock %}


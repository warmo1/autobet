{% extends 'base.html' %}

{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-3">
  <h1 class="mb-3">Superfecta Calculator</h1>
  <p class="text-muted">Analyse current Tote pools using BigQuery permutations and expected value modelling.</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="GET" class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Inputs</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="product_id" class="form-label">Product</label>
          <select id="product_id" name="product_id" class="form-select" required>
            {% if options %}
              {% for opt in options %}
                <option value="{{ opt.product_id }}" {% if opt.product_id == product_id %}selected{% endif %}>
                  {{ opt.event_name or 'Event' }} ({{ opt.venue or 'Venue' }}) — {{ opt.start_iso }}
                </option>
              {% endfor %}
            {% else %}
              <option value="" selected disabled>No products available</option>
            {% endif %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="top_n" class="form-label">Top N Runners</label>
          <input type="number" class="form-control" id="top_n" name="top_n" min="4" max="30" value="{{ form_values.top_n }}">
        </div>
        <div class="col-md-2">
          <label for="coverage" class="form-label">Coverage (%)</label>
          <input type="number" class="form-control" id="coverage" name="coverage" min="1" max="100" step="1" value="{{ (form_values.coverage * 100) | round(1) }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Include My Stake</label>
          <div class="form-check form-switch mt-1">
            <input class="form-check-input" type="checkbox" id="inc" name="inc" value="1" {% if form_values.include_self %}checked{% endif %}>
            <label class="form-check-label" for="inc">Yes</label>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-2">
          <label for="bankroll" class="form-label">Total Bankroll (£)</label>
          <input type="number" step="0.01" min="0" class="form-control" id="bankroll" name="bankroll" value="{{ form_values.bankroll | round(2) }}">
        </div>
        <div class="col-md-2">
          <label for="min_stake_per_line" class="form-label">Min Stake / Line (£)</label>
          <input type="number" step="0.01" min="0" class="form-control" id="min_stake_per_line" name="min_stake_per_line" value="{{ form_values.min_stake_per_line | round(2) }}">
        </div>
        <div class="col-md-2">
          <label for="stake_per_line" class="form-label">Stake / Line (£)</label>
          <input type="number" step="0.01" min="0" class="form-control" id="stake_per_line" name="stake_per_line" value="{{ form_values.stake_per_line | round(2) }}">
          <div class="form-text">Used for breakeven estimates.</div>
        </div>
        <div class="col-md-2">
          <label for="take_rate" class="form-label">Take Rate (%)</label>
          <input type="number" step="0.1" min="0" max="100" class="form-control" id="take_rate" name="takeout" value="{{ (form_values.take_rate * 100) | round(2) }}">
        </div>
        <div class="col-md-2">
          <label for="net_rollover" class="form-label">Net Rollover (£)</label>
          <input type="number" step="0.01" class="form-control" id="net_rollover" name="rollover" value="{{ form_values.net_rollover | round(2) }}">
        </div>
        <div class="col-md-2">
          <label for="pool_gross" class="form-label">Current Pool (£)</label>
          <input type="number" step="0.01" min="0" class="form-control" id="pool_gross" name="pool_gross" value="{{ form_values.pool_gross | round(2) }}">
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-2">
          <label for="div_mult" class="form-label">Dividend Multiplier</label>
          <input type="number" step="0.01" min="0" class="form-control" id="div_mult" name="div_mult" value="{{ form_values.div_mult | round(2) }}">
        </div>
        <div class="col-md-2">
          <label for="concentration" class="form-label">Concentration (%)</label>
          <input type="number" step="1" min="0" max="100" class="form-control" id="concentration" name="concentration" value="{{ (form_values.concentration * 100) | round(0) }}">
          <div class="form-text">Higher focuses on top lines.</div>
        </div>
        <div class="col-md-2">
          <label for="market_inefficiency" class="form-label">Market Ineff. (%)</label>
          <input type="number" step="1" min="0" max="100" class="form-control" id="market_inefficiency" name="market_inefficiency" value="{{ (form_values.market_inefficiency * 100) | round(0) }}">
          <div class="form-text">How inefficient the pool is assumed to be.</div>
        </div>
        <div class="col-md-2">
          <label for="f_share_override" class="form-label">f-share Override</label>
          <input type="number" step="0.0001" min="0" max="1" class="form-control" id="f_share_override" name="f_share_override" value="{{ form_values.f_share if form_values.f_share is not none }}" placeholder="Auto">
        </div>
        <div class="col-md-4">
          <label for="date" class="form-label">Date</label>
          <input type="date" class="form-control" id="date" name="date" value="{{ form_values.date }}">
        </div>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-between">
      <div>
        <input type="hidden" name="bet_type" value="{{ bet_type }}">
      </div>
      <button type="submit" class="btn btn-primary">Run Calculation</button>
    </div>
  </form>

  {% if product_details %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Product Summary</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <dl class="row mb-0">
              <dt class="col-sm-5">Event</dt>
              <dd class="col-sm-7">{{ product_details.event_name or '—' }}</dd>
              <dt class="col-sm-5">Venue</dt>
              <dd class="col-sm-7">{{ product_details.venue or '—' }}</dd>
              <dt class="col-sm-5">Start Time</dt>
              <dd class="col-sm-7">{{ product_details.start_iso or '—' }}</dd>
              <dt class="col-sm-5">Status</dt>
              <dd class="col-sm-7">{{ product_details.status or '—' }}</dd>
            </dl>
          </div>
          <div class="col-md-6">
            <dl class="row mb-0">
              <dt class="col-sm-6">Total Gross (£)</dt>
              <dd class="col-sm-6">{{ product_details.total_gross | round(2) if product_details.total_gross is not none else '—' }}</dd>
              <dt class="col-sm-6">Total Net (£)</dt>
              <dd class="col-sm-6">{{ product_details.total_net | round(2) if product_details.total_net is not none else '—' }}</dd>
              <dt class="col-sm-6">Deduction Rate</dt>
              <dd class="col-sm-6">{{ ((product_details.deduction_rate or 0) * 100) | round(2) }}%</dd>
              <dt class="col-sm-6">Rollover (£)</dt>
              <dd class="col-sm-6">{{ product_details.rollover | round(2) if product_details.rollover is not none else '—' }}</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% if recommendation %}
    <div class="card mb-4 border-success">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">Recommended Coverage</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="small text-muted">Lines to Cover</div>
            <div class="h5 mb-0">{{ recommendation.lines }}</div>
          </div>
          <div class="col-md-3">
            <div class="small text-muted">Hit Rate</div>
            <div class="h5 mb-0">{{ (recommendation.hit_rate * 100) | round(2) if recommendation.hit_rate is not none else '—' }}%</div>
          </div>
          <div class="col-md-3">
            <div class="small text-muted">Expected Profit</div>
            <div class="h5 mb-0">£{{ recommendation.expected_profit | round(2) if recommendation.expected_profit is not none else '—' }}</div>
          </div>
          <div class="col-md-3">
            <div class="small text-muted">Stake / Line</div>
            <div class="h5 mb-0">£{{ recommendation.stake_per_line | round(2) if recommendation.stake_per_line is not none else '—' }}</div>
          </div>
        </div>
        <div class="mt-2">
          <span class="badge bg-light text-dark">Coverage ~ {{ recommendation.coverage_pct | round(1) if recommendation.coverage_pct is not none else '—' }}%</span>
          <span class="badge bg-light text-dark">Total Stake £{{ recommendation.stake_total | round(2) if recommendation.stake_total is not none else '—' }}</span>
          {% if not recommendation.feasible %}
            <span class="badge bg-warning text-dark">Below minimum stake per line</span>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

  {% if chart_data.labels %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Expected Value by Coverage</h5>
      </div>
      <div class="card-body">
        <canvas id="evChart" height="120"></canvas>
      </div>
    </div>
  {% endif %}

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Top Permutations</h5>
        </div>
        <div class="card-body table-responsive">
          {% if permutation_summary and permutation_summary.preview_lines %}
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Line</th>
                  <th>p</th>
                  <th>Cumulative</th>
                </tr>
              </thead>
              <tbody>
                {% for row in permutation_summary.preview_lines %}
                  <tr>
                    <td>{{ row.rank }}</td>
                    <td>{{ row.line }}</td>
                    <td>{{ row.probability | round(5) }}</td>
                    <td>{{ row.cum_probability | round(5) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="text-muted mb-0">No permutations available yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Recommended Lines</h5>
        </div>
        <div class="card-body table-responsive">
          {% if recommended_lines %}
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Line</th>
                  <th>p</th>
                  <th>Cumulative</th>
                </tr>
              </thead>
              <tbody>
                {% for row in recommended_lines %}
                  <tr>
                    <td>{{ row.rank }}</td>
                    <td>{{ row.line }}</td>
                    <td>{{ row.probability | round(5) }}</td>
                    <td>{{ row.cum_probability | round(5) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="text-muted mb-0">Run the model to view recommended coverage.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-4 mb-4">
    <div class="card-header">
      <h5 class="mb-0">EV Grid</h5>
    </div>
    <div class="card-body table-responsive">
      {% if ev_grid %}
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Lines</th>
              <th>Hit Rate (%)</th>
              <th>Expected Return (£)</th>
              <th>Expected Profit (£)</th>
              <th>Stake / Line (£)</th>
              <th>Feasible</th>
            </tr>
          </thead>
          <tbody>
            {% for row in ev_grid %}
              <tr {% if recommendation and row.lines_covered == recommendation.lines %}class="table-success"{% endif %}>
                <td>{{ row.lines_covered }}</td>
                <td>{{ (row.hit_rate * 100) | round(2) if row.hit_rate is not none else '—' }}</td>
                <td>{{ row.expected_return | round(2) if row.expected_return is not none else '—' }}</td>
                <td>{{ row.expected_profit | round(2) if row.expected_profit is not none else '—' }}</td>
                <td>{{ row.stake_per_line | round(2) if row.stake_per_line is not none else '—' }}</td>
                <td>{% if row.feasible %}<span class="badge bg-success">Yes</span>{% else %}<span class="badge bg-warning text-dark">No</span>{% endif %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="text-muted mb-0">Run the model to populate the EV grid.</p>
      {% endif %}
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Runners</h5>
    </div>
    <div class="card-body table-responsive">
      {% if runners %}
        <table class="table table-sm">
          <thead>
            <tr>
              <th>#</th>
              <th>Competitor</th>
              <th>Total Units</th>
              <th>Share (%)</th>
              <th>Probable Odds</th>
            </tr>
          </thead>
          <tbody>
            {% for runner in runners %}
              <tr>
                <td>{{ runner.number if runner.number is not none else '—' }}</td>
                <td>{{ runner.competitor or '—' }}</td>
                <td>{{ runner.total_units | round(2) if runner.total_units is not none else '—' }}</td>
                <td>{{ (runner.pct_units * 100) | round(2) if runner.pct_units is not none else '—' }}</td>
                <td>{{ runner.prob_odds | round(2) if runner.prob_odds is not none else '—' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="text-muted mb-0">No runner information available yet.</p>
      {% endif %}
    </div>
  </div>
</div>

{% if chart_data.labels %}
<script>
  (function() {
    const chartData = {{ chart_data | tojson | safe }};
    if (!chartData || !chartData.labels || chartData.labels.length === 0) {
      return;
    }
    const ctx = document.getElementById('evChart');
    if (!ctx) {
      return;
    }
    const profitData = (chartData.expected_profit || []).map(v => v === null ? null : Number(v));
    const returnData = (chartData.expected_return || []).map(v => v === null ? null : Number(v));
    const hitRateData = (chartData.hit_rate || []).map(v => v === null ? null : Number(v) * 100);
    const feasible = chartData.feasible || [];

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [
          {
            label: 'Expected Profit (£)',
            data: profitData,
            yAxisID: 'y',
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13,110,253,0.15)',
            tension: 0.2,
            spanGaps: true,
          },
          {
            label: 'Expected Return (£)',
            data: returnData,
            yAxisID: 'y',
            borderColor: '#6610f2',
            backgroundColor: 'rgba(102,16,242,0.15)',
            tension: 0.2,
            borderDash: [6, 4],
            spanGaps: true,
          },
          {
            label: 'Hit Rate (%)',
            data: hitRateData,
            yAxisID: 'y1',
            borderColor: '#198754',
            backgroundColor: 'rgba(25,135,84,0.15)',
            tension: 0.2,
            spanGaps: true,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: '£' },
            ticks: { callback: value => `£${value}` }
          },
          y1: {
            type: 'linear',
            position: 'right',
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'Hit Rate (%)' }
          }
        },
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const val = context.parsed.y;
                if (label.includes('Hit Rate')) {
                  return `${label}: ${val.toFixed(2)}%`;
                }
                return `${label}: £${val.toFixed(2)}`;
              }
            }
          }
        }
      }
    });
  })();
</script>
{% endif %}
{% endblock %}

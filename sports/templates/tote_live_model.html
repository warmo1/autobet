{% extends "base.html" %}

{% block title %}Live Model Analysis{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Live Model Analysis</h1>
        <a href="{{ url_for('tote_live_model_page') }}" class="btn btn-primary">Refresh</a>
    </div>

    <p class="text-muted">
        This page shows upcoming Superfecta events. Click 'Calculate' to run the Plackett-Luce model and generate a staking plan.
    </p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="GET" action="{{ url_for('tote_live_model_page') }}" class="row g-3 align-items-end bg-light p-3 rounded mb-4">
        <div class="col-md-3">
            <label for="country" class="form-label">Country</label>
            <select name="country" id="country" class="form-select">
                <option value="">All</option>
                {% for c in country_options %}
                <option value="{{ c }}" {% if filters.country == c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="venue" class="form-label">Venue</label>
            <input list="venue-list" name="venue" id="venue" class="form-control" value="{{ filters.venue }}" placeholder="e.g. Ascot">
            <datalist id="venue-list">
                {% for v in (venue_options or []) %}
                {% if v %}<option value="{{ v }}">{% endif %}
                {% endfor %}
            </datalist>
        </div>
        <div class="col-md-3">
            <label for="date" class="form-label">Date</label>
            <input type="date" name="date" id="date" class="form-control" value="{{ filters.date }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-secondary w-100">Filter</button>
        </div>
    </form>

    {% if calculation_result %}
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5>Model Calculation: {{ calculation_result.product.event_name }} - {{ calculation_result.product.venue }}</h5>
            <small>Start Time: <span class="time-iso" data-iso="{{ calculation_result.product.start_iso }}">{{ calculation_result.product.start_iso }}</span></small>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6>Model Output</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Expected Profit
                            <span class="badge bg-primary rounded-pill">£{{ calculation_result.scenario.expected_profit | f2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Lines Covered
                            <span>{{ calculation_result.scenario.lines_covered }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Hit Rate
                            <span>{{ calculation_result.scenario.hit_rate | pct1 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total Stake
                            <span>£{{ calculation_result.total_stake | f2 }}</span>
                        </li>
                        {% if calculation_result.min_stake_per_line is not none %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Minimum Stake / Line (model)
                            <span>£{{ calculation_result.min_stake_per_line | f2 }}</span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="col-md-8">
                    <h6>Staking Plan ({{ calculation_result.scenario.lines_covered }} lines)</h6>
                    <form method="POST" action="{{ url_for('tote_live_model_page') }}">
                        <input type="hidden" name="product_id" value="{{ calculation_result.product.product_id }}">
                        <input type="hidden" name="stake" value="{{ calculation_result.total_stake }}">
                        <textarea name="selections_text" class="form-control" rows="5" readonly>{{ calculation_result.staking_plan_text }}</textarea>
                        {% if calculation_result.weighted_lines %}
                        <input type="hidden" name="lines_json" value='{{ calculation_result.weighted_lines | tojson }}'>
                        {% endif %}
                        <div class="mt-3">
                            <button type="submit" name="mode" value="audit" class="btn btn-info">Place Bet (Audit)</button>
                            <button type="submit" name="mode" value="live" class="btn btn-danger" onclick="return confirm('Place LIVE bet of £{{ calculation_result.total_stake | f2 }}?');">Place Bet (Live)</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% if calculation_result.ev_grid %}
    <div class="card mb-4">
        <div class="card-header">
            <h5>Expected Profit vs. Lines Covered</h5>
            <p class="small text-muted mb-0">Explore how coverage impacts expected value. The slider defaults to the model's suggested number of lines.</p>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-lg-8">
                    <canvas id="liveEvChart"></canvas>
                </div>
                <div class="col-lg-4">
                    <label for="evLinesRange" class="form-label">Lines to Cover</label>
                    <input type="range" class="form-range" id="evLinesRange" min="1" max="{{ calculation_result.ev_grid | length }}" value="1" data-default-lines="{{ calculation_result.scenario.lines_covered }}">
                    <div class="mt-3">
                        <div><strong>Lines Selected:</strong> <span id="evLinesValue">-</span></div>
                        <div><strong>Expected Profit:</strong> £<span id="evProfitValue">-</span></div>
                        <div><strong>Hit Rate:</strong> <span id="evHitRateValue">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <hr>
    {% endif %}

    <h3 class="mt-4">Upcoming Events</h3>
    {% if not events %}
        <div class="alert alert-info mt-4">No upcoming events found matching the criteria.</div>
    {% else %}
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Venue</th>
                    <th>Start Time</th>
                    <th>Pool Gross+Rollover</th>
                    <th>Pool Net+Rollover</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            {% for event in events %}
                <tr>
                    <td>{{ event.event_name }}</td>
                    <td>{{ event.venue }}</td>
                    <td><span class="time-iso" data-iso="{{ event.start_iso }}">{{ event.start_iso }}</span></td>
                    <td>{{ event.currency }} {{ ((event.total_gross or 0) + (event.rollover or 0)) | f2 }}</td>
                    <td>{{ event.currency }} {{ ((event.total_net or 0) + (event.rollover or 0)) | f2 }}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-secondary me-2 btn-refresh-odds" data-eid="{{ event.event_id }}" title="Refresh probable odds from Tote API">
                            Refresh Odds
                        </button>
                        <a href="{{ url_for('tote_product_calculator_page', product_id=event.product_id) }}" class="btn btn-sm btn-success">Calculate</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if calculation_result and calculation_result.ev_grid %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.btn-refresh-odds').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const originalText = btn.textContent;
      if (btn.disabled) return;

      btn.disabled = true;
      btn.textContent = 'Refreshing...';
      try {
        const eid = btn.dataset.eid;
        if (!eid) throw new Error('Event ID not found on button.');
        
        const res = await fetch(`/api/tote/refresh_odds/${eid}`, { method: 'POST' });
        const j = await res.json().catch(()=>({error: 'Invalid JSON response'}));
        
        if (!res.ok || j.error) {
            throw new Error(j.error || `Refresh failed with status ${res.status}`);
        }

        btn.textContent = 'Refreshed';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-success');
      } catch (err) {
        console.error('Refresh odds failed:', err);
        btn.textContent = 'Error';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-danger');
      }
    });
  });

  {% if calculation_result and calculation_result.ev_grid %}
  (function(){
    const evData = {{ calculation_result.ev_grid | tojson }};
    if (!Array.isArray(evData) || evData.length === 0) {
      return;
    }

    const labels = evData.map(r => r.lines_covered);
    const profits = evData.map(r => r.expected_profit);
    const ctx = document.getElementById('liveEvChart')?.getContext('2d');
    if (ctx) {
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Expected Profit (£)',
            data: profits,
            tension: 0.18,
            fill: true,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            pointRadius: 0,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: 'Lines Covered' } },
            y: { title: { display: true, text: 'Expected Profit (£)' } }
          }
        }
      });

      const slider = document.getElementById('evLinesRange');
      const linesEl = document.getElementById('evLinesValue');
      const profitEl = document.getElementById('evProfitValue');
      const hitEl = document.getElementById('evHitRateValue');
      const hitRates = evData.map(r => typeof r.hit_rate === 'number' ? r.hit_rate : 0);

      function sync(idx){
        const row = evData[idx];
        if (!row) return;
        linesEl.textContent = row.lines_covered;
        const profit = typeof row.expected_profit === 'number' ? row.expected_profit : 0;
        profitEl.textContent = profit.toFixed(2);
        const hr = hitRates[idx] || 0;
        hitEl.textContent = (hr * 100).toFixed(2) + '%';
        chart.setActiveElements([{ datasetIndex: 0, index: idx }]);
        chart.tooltip.setActiveElements([{ datasetIndex: 0, index: idx }], { x: 0, y: 0 });
        chart.update();
      }

      if (slider) {
        const defaultLines = parseInt(slider.dataset.defaultLines || '0', 10);
        const defaultIndex = Math.max(0, labels.findIndex(v => v === defaultLines));
        slider.value = defaultIndex >= 0 ? defaultIndex + 1 : 1;
        sync(defaultIndex >= 0 ? defaultIndex : 0);
        slider.addEventListener('input', (ev) => {
          const idx = Math.min(evData.length - 1, Math.max(0, parseInt(ev.target.value, 10) - 1));
          sync(idx);
        });
      }
    }
  })();
  {% endif %}
});
</script>
{% endblock %}

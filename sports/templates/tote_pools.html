{% extends 'base.html' %}
{% block content %}
<div class="container mt-3">
  <h3 class="mb-3">Tote Pools</h3>

  <div class="card mb-3">
    <div class="card-header">Filters</div>
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end">
        <div class="col-sm-3 col-md-2">
          <label class="form-label small">Bet Type</label>
          <select class="form-select form-select-sm" name="bet_type">
            <option value="">All</option>
            {% for t in bet_type_options %}<option value="{{ t }}" {% if filters.bet_type==t %}selected{% endif %}>{{ t }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-3 col-md-2">
          <label class="form-label small">Country</label>
          <select class="form-select form-select-sm" name="country">
            <option value="">All</option>
            {% for c in country_options %}<option value="{{ c }}" {% if filters.country==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-3 col-md-3">
          <label class="form-label small">Venue</label>
          <select class="form-select form-select-sm" name="venue">
            <option value="">All</option>
            {% for v in venue_options %}<option value="{{ v }}" {% if filters.venue==v %}selected{% endif %}>{{ v }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-3 col-md-2">
          <label class="form-label small">Status</label>
          <select class="form-select form-select-sm" name="status">
            <option value="">Any</option>
            {% for s in ['OPEN','CLOSED','SETTLED'] %}<option value="{{ s }}" {% if filters.status==s %}selected{% endif %}>{{ s }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-4 col-md-2">
          <label class="form-label small">Date</label>
          <input type="date" class="form-control form-control-sm" name="date" value="{{ filters.date }}">
        </div>
        <div class="col-sm-8 col-md-1 d-grid">
          <button class="btn btn-sm btn-primary" type="submit">Apply</button>
        </div>
      </form>
    </div>
  </div>

  <div class="table-responsive" style="max-height: 65vh;">
    <table class="table table-sm table-striped align-middle">
      <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
        <tr>
          <th title="Local start time of the event">Start</th>
          <th title="Pool type (e.g., WIN, EXACTA, SUPERFECTA)">Bet</th>
          <th title="Event name (click for details)">Event</th>
          <th>Venue</th>
          <th>Country</th>
          <th>Status</th>
          <th class="text-end" title="Total pool before takeout">Gross</th>
          <th class="text-end" title="Pool after takeout">Net</th>
          <th class="text-end" title="Funds carried in">Rollover</th>
          <th class="text-end" title="Operator fee">Takeout</th>
          <th class="text-end" title="Reported dividend rows">Divs</th>
        </tr>
      </thead>
      <tbody>
        {% for p in products %}
        <tr>
          <td data-product-id="{{ p.product_id }}"><span class="time-iso" data-iso="{{ p.start_iso }}">{{ p.start_iso }}</span></td>
          <td>{{ p.bet_type }}</td>
          <td><a href="{{ url_for('event_detail', event_id=p.event_id) }}">{{ p.event_name }}</a></td>
          <td>{{ p.venue }}</td>
          <td>{{ p.country }}</td>
          <td data-field="status">{{ p.status }}</td>
          <td class="text-end"><span data-field="total_gross">{{ p.total_gross | f0 }}</span></td>
          <td class="text-end"><span data-field="total_net">{{ p.total_net | f0 }}</span></td>
          <td class="text-end"><span data-field="rollover">{{ p.rollover | f0 }}</span></td>
          <td class="text-end">{{ p.deduction_rate | pct1 }}</td>
          <td class="text-end">{{ p.dividend_count }}</td>
        </tr>
        {% else %}
        <tr><td colspan="9" class="text-center text-muted">No pools found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between mt-2">
    <div class="text-muted small">Showing {{ filters.page }} page(s). Total: {{ totals.total }} items</div>
    <div>
      {% set prevp = (filters.page-1) if filters.page>1 else 1 %}
      {% set nextp = (filters.page+1) %}
      <a class="btn btn-sm btn-outline-secondary" href="?page={{ prevp }}&limit={{ filters.limit }}&bet_type={{ filters.bet_type }}&country={{ filters.country }}&venue={{ filters.venue }}&status={{ filters.status }}&date={{ filters.date }}">Prev</a>
      <a class="btn btn-sm btn-outline-secondary" href="?page={{ nextp }}&limit={{ filters.limit }}&bet_type={{ filters.bet_type }}&country={{ filters.country }}&venue={{ filters.venue }}&status={{ filters.status }}&date={{ filters.date }}">Next</a>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const productRows = new Map();
    document.querySelectorAll('td[data-product-id]').forEach(cell => {
        productRows.set(cell.dataset.productId, cell.closest('tr'));
    });

    if (productRows.size === 0) return;

    const es = new EventSource("{{ url_for('stream') }}?topic=pool_total_changed&topic=product_status_changed");

    const formatters = {
        f0: (val) => parseFloat(val).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }),
    };

    const updateCell = (row, field, value, formatter) => {
        const cell = row.querySelector(`[data-field="${field}"]`);
        if (cell) {
            cell.textContent = formatter ? formatter(value) : value;
            // Flash effect
            cell.style.transition = 'none';
            cell.style.backgroundColor = '#fdffc4';
            setTimeout(() => {
                cell.style.transition = 'background-color 0.5s ease';
                cell.style.backgroundColor = '';
            }, 150);
        }
    };

    es.addEventListener('pool_total_changed', (e) => {
        const data = JSON.parse(e.data);
        const row = productRows.get(data.product_id);
        if (row) {
            if (data.total_gross !== null) updateCell(row, 'total_gross', data.total_gross, formatters.f0);
            if (data.total_net !== null) updateCell(row, 'total_net', data.total_net, formatters.f0);
            if (data.rollover !== null) updateCell(row, 'rollover', data.rollover, formatters.f0);
        }
    });

    es.addEventListener('product_status_changed', (e) => {
        const data = JSON.parse(e.data);
        const row = productRows.get(data.product_id);
        if (row) {
            updateCell(row, 'status', data.status);
        }
    });
});
</script>
{% endblock %}

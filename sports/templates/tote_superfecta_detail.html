{% extends 'base.html' %}
{% block content %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Superfecta Builder</strong>
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('tote_superfecta_page') }}">Back</a>
  </div>
  <div class="card-body">
    <div id="placementInfo" class="alert alert-info" style="display:none;"></div>
    <div class="mb-2">
      <div><strong>Event:</strong> {{ product.event_name }} ({{ product.venue }})</div>
      <div class="small text-muted">Start: <span class="time-iso" data-iso="{{ product.start_iso }}">{{ product.start_iso }}</span> - Product: {{ product.product_id }}</div>
      {% if conditions %}
      <div class="small mt-1">
        <span class="badge bg-light text-dark">Going: {{ conditions.going or '—' }}</span>
        <span class="badge bg-light text-dark ms-1">Temp: {{ conditions.weather_temp_c is not none and (conditions.weather_temp_c | round(0) | int) ~ '°C' or '—' }}</span>
        <span class="badge bg-light text-dark ms-1">Wind: {{ conditions.weather_wind_kph is not none and (conditions.weather_wind_kph | round(0) | int) ~ ' kph' or '—' }}</span>
        <span class="badge bg-light text-dark ms-1">Precip: {{ conditions.weather_precip_mm is not none and (conditions.weather_precip_mm | round(1)) ~ ' mm' or '—' }}</span>
      </div>
      {% endif %}
    </div>
    <div class="row">
      <div class="col-lg-7">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>#</th><th>Runner</th></tr></thead>
            <tbody>
              {% for r in runners %}
                <tr><td>{{ r.cloth }}</td><td>{{ r.name }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if finishing %}
        <div class="mt-3">
          <strong>Finishing Order</strong>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>Pos</th><th>Cloth</th><th>Horse</th><th>Status</th></tr></thead>
              <tbody>
                {% for f in finishing %}
                  <tr>
                    <td>{{ f.finish_pos }}</td>
                    <td>{{ f.cloth_number }}</td>
                    <td>{{ f.horse_id }}</td>
                    <td>{{ f.status }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
        {% if dividends %}
        <div class="mt-3">
          <strong>Reported Dividends</strong>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>Selection</th><th>Dividend</th><th>Last Seen</th></tr></thead>
              <tbody>
                {% for d in dividends %}
                  <tr><td>{{ d.selection }}</td><td>{{ '%.2f'|format(d.dividend or 0) }}</td><td>{{ d.ts }}</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
      </div>
      <div class="col-lg-5">
        <div class="card">
          <div class="card-header">Audit Bet Placement</div>
          <div class="card-body">
            <form method="post" action="{{ url_for('tote_audit_superfecta_post') }}">
              <input type="hidden" name="product_id" value="{{ product.product_id }}" />
              <input type="hidden" name="post" value="on" />
              <input type="hidden" name="stake_type" value="line" />
              <div class="mb-3">
                <label for="selections_text" class="form-label">Selections (one per line)</label>
                <textarea class="form-control" name="selections_text" id="selections_text" rows="5" placeholder="e.g.&#10;3-7-1-5&#10;2-3-1-6"></textarea>
                <div class="form-text">Enter each superfecta combination on a new line.</div>
              </div>
              <div class="mb-3">
                <label for="stake" class="form-label">Stake per line (£)</label>
                <input class="form-control" type="number" step="0.01" min="0.01" name="stake" id="stake" value="0.10" />
              </div>
              <button type="submit" class="btn btn-primary w-100" onclick="return confirm('Audit mode: submit multiple lines?')">Submit Audit Bet</button>
            </form>
          </div>
        </div>

        <div id="pool-info" class="mt-3"></div>
        <script>
          async function fetchPoolInfo() {
            const poolInfoDiv = document.getElementById('pool-info');
            try {
              const response = await fetch(`/api/tote/pool_snapshot/{{ product.product_id }}`);
              if (!response.ok) {
                  poolInfoDiv.innerHTML = `<div class="alert alert-warning small">Could not fetch live pool info (Status: ${response.status}).</div>`;
                  return;
              }
              const data = await response.json();
              if (data && data.total_gross !== null) {
                poolInfoDiv.innerHTML = `
                  <div class="card">
                    <div class="card-header">Live Pool Info</div>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item d-flex justify-content-between"><span>Gross Pool</span> <strong>£${(data.total_gross || 0).toFixed(2)}</strong></li>
                      <li class="list-group-item d-flex justify-content-between"><span>Net Pool</span> <strong>£${(data.total_net || 0).toFixed(2)}</strong></li>
                      <li class="list-group-item d-flex justify-content-between"><span>Rollover</span> <strong>£${(data.rollover || 0).toFixed(2)}</strong></li>
                    </ul>
                  </div>
                `;
              } else {
                  poolInfoDiv.innerHTML = '<div class="alert alert-secondary small">No live pool data available yet.</div>';
              }
            } catch (error) {
              poolInfoDiv.innerHTML = '<div class="alert alert-danger small">Error fetching pool info.</div>';
            }
          }

          fetchPoolInfo();
          setInterval(fetchPoolInfo, 5000); // Refresh every 5 seconds
        </script>
        
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  document.querySelectorAll('.btn-refresh-bet').forEach(function(btn){
    btn.addEventListener('click', async function(){
      const bid = btn.getAttribute('data-bid');
      const row = btn.closest('tr');
      try{
        btn.disabled = true; btn.textContent = 'Refreshing...';
        const r = await fetch('/api/tote/bet_status?bet_id=' + encodeURIComponent(bid));
        const d = await r.json();
        if(row){
          const oc = row.querySelector('.outcome');
          if(oc){ oc.textContent = d && d.outcome ? d.outcome : (d && d.status && d.status.status ? d.status.status : '—'); }
        }
      }catch(err){ /* noop */ }
      finally { btn.disabled = false; btn.textContent = 'Refresh'; }
    });
  });
})();
</script>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const btn = document.getElementById('btnCheckPlacement');
  const box = document.getElementById('placementInfo');
  if(btn && box){
    btn.addEventListener('click', async function(){
      try{
        const pid = {{ product.product_id | tojson }};
        const r = await fetch(`/api/tote/placement_id?product_id=${encodeURIComponent(pid)}`);
        const j = await r.json();
        if(j && !j.error){
          box.style.display='';
          box.innerText = `original=${j.original_product_id} -> placement=${j.placement_product_id} (method=${j.method}${j.selling_status? ', selling='+j.selling_status:''})`;
        }else{
          box.style.display='';
          box.innerText = 'Error: ' + (j && j.error ? j.error : 'unknown');
        }
      }catch(err){ box.style.display=''; box.innerText = 'Error checking placement id'; }
    });
  }
})();
</script>
{% endblock %}

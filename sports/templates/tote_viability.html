{% extends "base.html" %}

{% block title %}Viability Calculator{% endblock %}

{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h1>Pari-Mutuel Viability Calculator</h1>
<p class="text-muted">Analyze the Expected Value (EV) of covering a percentage of combinations in a pool.</p>

<div class="card">
<div class="card-body">
<form method="get" action="{{ url_for('tote_viability_page') }}" class="row g-3 align-items-end">
    <div class="col-md-2">
        <label for="bet_type" class="form-label">Bet Type</label>
        <select name="bet_type" id="bet_type" class="form-select">
            {% for bt in ["SUPERFECTA", "TRIFECTA", "EXACTA", "WIN"] %}
            <option value="{{ bt }}" {% if filters.bet_type == bt %}selected{% endif %}>{{ bt }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <label for="country" class="form-label">Country</label>
        <select name="country" id="country" class="form-select">
            {% for c in country_options %}<option value="{{ c }}" {% if filters.country == c %}selected{% endif %}>{{ c }}</option>{% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <label for="date" class="form-label">Date</label>
        <input type="date" name="date" id="date" value="{{ filters.date }}" class="form-control">
    </div>
    <div class="col-md-3">
        <label for="venue" class="form-label">Venue</label>
        <select name="venue" id="venue" class="form-select">
            <option value="">-- Any Venue --</option>
            {% for v in venue_options %}<option value="{{ v }}" {% if filters.venue == v %}selected{% endif %}>{{ v }}</option>{% endfor %}
        </select>
    </div>
    <div class="col-md-3">
        <button type="submit" class="btn btn-secondary w-100">Filter Races</button>
    </div>
</form>
</div>
</div>

<div class="card mt-3">
<div class="card-header">Select a Race</div>
<div class="card-body p-0">
    <div class="table-responsive" style="max-height: 300px;">
    <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
            <tr><th>Start</th><th>Event</th><th>Venue</th><th>Status</th><th class="text-end">Runners</th><th class="text-end">Pool (Gross)</th><th></th></tr>
        </thead>
        <tbody>
            {% for p in products %}
            <tr class="{% if p.product_id == product_id %}table-primary{% endif %}">
                <td>{{ p.start_iso[11:16] }}</td>
                <td>{{ p.event_name }}</td>
                <td>{{ p.venue }}</td>
                <td><span class="badge bg-light text-dark">{{ p.status }}</span></td>
                <td class="text-end">{{ p.n_runners }}</td>
                <td class="text-end">{{ "%.0f"|format(p.total_gross or 0) }}</td>
                <td><a href="{{ url_for('tote_viability_page', product_id=p.product_id, **request.args) }}" class="btn btn-sm btn-outline-primary">Select</a></td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center text-muted p-3">No products found for these filters.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>
</div>

{% if product_id and product_details %}
<div class="row g-3 mt-1">
<div class="col-lg-4">
    <div class="card">
        <div class="card-header">Calculation Parameters</div>
        <div class="card-body">
            <form method="get" action="{{ url_for('tote_viability_page') }}">
                <input type="hidden" name="product_id" value="{{ product_id }}">
                <input type="hidden" name="bet_type" value="{{ filters.bet_type }}">
                <input type="hidden" name="country" value="{{ filters.country }}">
                <input type="hidden" name="date" value="{{ filters.date }}">
                <input type="hidden" name="venue" value="{{ filters.venue }}">

                <div class="mb-2">
                    <label for="alpha" class="form-label">Coverage Target (%)</label>
                    <input type="number" step="1" min="0" max="100" name="alpha" id="alpha" value="{{ calc.coverage_pct }}" class="form-control">
                    <div class="form-text">What percentage of the total possible combinations to bet on.</div>
                </div>
                <div class="mb-2">
                    <label for="stake_per_line" class="form-label">Stake per Line (£)</label>
                    <input type="number" step="0.01" min="0.01" name="stake_per_line" id="stake_per_line" value="{{ calc.stake_per_line }}" class="form-control">
                </div>
                <div class="mb-2">
                    <label for="take" class="form-label">Pool Takeout Rate (%)</label>
                    <input type="number" step="0.1" name="take" id="take" value="{{ calc.take_rate * 100 }}" class="form-control">
                </div>
                <div class="mb-2">
                    <label for="rollover" class="form-label">Net Rollover (£)</label>
                    <input type="number" step="0.01" name="rollover" id="rollover" value="{{ calc.net_rollover }}" class="form-control">
                </div>
                <div class="mb-2">
                    <label for="f" class="form-label">Your Share of Winning Ticket (f)</label>
                    <input type="number" step="0.01" min="0" max="1" name="f" id="f" value="{{ calc.f_fix if calc.f_fix is not none }}" class="form-control" placeholder="Auto-calculated if blank">
                    <div class="form-text">Your proportion of the winning dividend. Leave blank to auto-calculate based on your stake relative to the total pool.</div>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="inc" name="inc" value="1" {% if calc.inc_self %}checked{% endif %}>
                    <label class="form-check-label" for="inc">Include own stake in pool calculation</label>
                </div>
                <button type="submit" class="btn btn-primary w-100">Recalculate</button>
            </form>
        </div>
    </div>
</div>

<div class="col-lg-8">
    <div class="card">
        <div class="card-header">Viability Results</div>
        <div class="card-body">
            {% if viab %}
            <div class="row">
                <div class="col-md-6">
                    <h5>Your Bet</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between"><span>Lines Covered (M)</span> <strong>{{ viab.lines_covered | int }}</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>Total Stake</span> <strong>£{{ "%.2f"|format(viab.stake_total or 0) }}</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>Coverage (α)</span> <strong>{{ "%.2f"|format((viab.coverage_frac or 0) * 100) }}%</strong></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>Pool State</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between"><span>Total Permutations (C)</span> <strong>{{ viab.total_lines | int }}</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>Net Pool (with your bet)</span> <strong>£{{ "%.2f"|format(viab.net_pool_if_bet or 0) }}</strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>f-share Used</span> <strong>{{ "%.4f"|format(viab.f_share_used or 0) }}</strong></li>
                    </ul>
                </div>
            </div>
            <div class="alert {% if viab.is_positive_ev %}alert-success{% else %}alert-danger{% endif %} text-center mt-3">
                <h4>Expected Profit: £{{ "%.2f"|format(viab.expected_profit or 0) }}</h4>
                <p class="mb-0">Expected Return: £{{ "%.2f"|format(viab.expected_return or 0) }}</p>
            </div>
            {% else %}
            <div class="alert alert-warning">No viability results. Check if there are enough runners for the selected bet type.</div>
            {% endif %}
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header">EV Grid vs. Coverage</div>
        <div class="card-body">
            <canvas id="evChart"></canvas>
        </div>
    </div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gridData = {{ grid | tojson }};
    if (gridData && gridData.length > 0) {
        const ctx = document.getElementById('evChart').getContext('2d');
        const labels = gridData.map(d => (d.coverage_frac * 100).toFixed(1) + '%');
        const profits = gridData.map(d => d.expected_profit);
        
        // Find the peak EV
        let maxProfit = -Infinity;
        let peakCoverage = 0;
        profits.forEach((profit, index) => {
            if (profit > maxProfit) {
                maxProfit = profit;
                peakCoverage = parseFloat(labels[index]);
            }
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Expected Profit (£)',
                    data: profits,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Expected Profit vs. Pool Coverage'
                    },
                    subtitle: {
                        display: true,
                        text: `Peak EV of £${maxProfit.toFixed(2)} at ~${peakCoverage.toFixed(1)}% coverage.`,
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: maxProfit > 0 ? '#16a34a' : '#dc2626'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Expected Profit (£)'
                        },
                        ticks: {
                            callback: function(value, index, values) {
                                return '£' + value.toFixed(2);
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Coverage (%)'
                        }
                    }
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: 0,
                            yMax: 0,
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 2,
                            borderDash: [6, 6],
                            label: {
                                content: 'Breakeven',
                                enabled: true,
                                position: 'end'
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}

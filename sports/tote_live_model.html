{% extends "base.html" %}

{% block title %}Live Model Analysis{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Live Model Analysis</h1>
        <a href="{{ url_for('tote_live_model_page') }}" class="btn btn-primary">Refresh</a>
    </div>

    <p class="text-muted">
        This page shows upcoming Superfecta events. Click 'Calculate' to run the Plackett-Luce model and generate a staking plan.
    </p>

    <form method="GET" action="{{ url_for('tote_live_model_page') }}" class="row g-3 align-items-end bg-light p-3 rounded mb-4">
        <div class="col-md-3">
            <label for="country" class="form-label">Country</label>
            <select name="country" id="country" class="form-select">
                <option value="">All</option>
                {% for c in country_options %}
                <option value="{{ c }}" {% if filters.country == c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="venue" class="form-label">Venue</label>
            <input list="venue-list" name="venue" id="venue" class="form-control" value="{{ filters.venue }}" placeholder="e.g. Ascot">
            <datalist id="venue-list">
                {% for v in (venue_options or []) %}
                {% if v %}<option value="{{ v }}">{% endif %}
                {% endfor %}
            </datalist>
        </div>
        <div class="col-md-3">
            <label for="date" class="form-label">Date</label>
            <input type="date" name="date" id="date" class="form-control" value="{{ filters.date }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-secondary w-100">Filter</button>
        </div>
    </form>

    {# Display calculation result if available #}
    {% if calculation_result %}
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5>Model Calculation: {{ calculation_result.product.event_name }} - {{ calculation_result.product.venue }}</h5>
            <small>Start Time: <span class="time-iso" data-iso="{{ calculation_result.product.start_iso }}">{{ calculation_result.product.start_iso }}</span></small>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6>Model Output</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Expected Profit
                            <span class="badge bg-primary rounded-pill">£{{ calculation_result.scenario.expected_profit | f2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Lines Covered
                            <span>{{ calculation_result.scenario.lines_covered }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Hit Rate
                            <span>{{ calculation_result.scenario.hit_rate | pct1 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total Stake
                            <span>£{{ calculation_result.total_stake | f2 }}</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-8">
                    <h6>Staking Plan ({{ calculation_result.scenario.lines_covered }} lines)</h6>
                    <form method="POST" action="{{ url_for('tote_live_model_page') }}">
                        <input type="hidden" name="product_id" value="{{ calculation_result.product.product_id }}">
                        <input type="hidden" name="stake" value="{{ calculation_result.total_stake }}">
                        <textarea name="selections_text" class="form-control" rows="5" readonly>{{ calculation_result.staking_plan_text }}</textarea>
                        {% if calculation_result.weighted_lines %}
                        <input type="hidden" name="lines_json" value='{{ calculation_result.weighted_lines | tojson }}'>
                        {% endif %}
                        <div class="mt-3">
                            <button type="submit" name="mode" value="audit" class="btn btn-info">Place Bet (Audit)</button>
                            <button type="submit" name="mode" value="live" class="btn btn-danger" onclick="return confirm('Place LIVE bet of £{{ calculation_result.total_stake | f2 }}?');">Place Bet (Live)</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <hr>
    {% endif %}

    {# Display list of upcoming events #}
    <h3 class="mt-4">Upcoming Events</h3>
    {% if not events %}
        <div class="alert alert-info mt-4">No upcoming events found matching the criteria.</div>
    {% else %}
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Venue</th>
                    <th>Start Time</th>
                    <th>Pool (Gross)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            {% for event in events %}
                <tr>
                    <td>{{ event.event_name }}</td>
                    <td>{{ event.venue }}</td>
                    <td><span class="time-iso" data-iso="{{ event.start_iso }}">{{ event.start_iso }}</span></td>
                    <td>{{ event.currency }} {{ event.total_gross | f2 }}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-secondary me-2 btn-refresh-odds" data-eid="{{ event.event_id }}" title="Refresh probable odds from Tote API">
                            Refresh Odds
                        </button>
                        <a href="{{ url_for('tote_product_calculator_page', product_id=event.product_id) }}" class="btn btn-sm btn-success">Calculate</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.btn-refresh-odds').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const originalText = btn.textContent;
      if (btn.disabled) return;

      btn.disabled = true;
      btn.textContent = 'Refreshing...';
      try {
        const eid = btn.dataset.eid;
        if (!eid) throw new Error('Event ID not found on button.');
        
        const res = await fetch(`/api/tote/refresh_odds/${eid}`, { method: 'POST' });
        const j = await res.json().catch(()=>({error: 'Invalid JSON response'}));
        
        if (!res.ok || j.error) {
            throw new Error(j.error || `Refresh failed with status ${res.status}`);
        }

        btn.textContent = 'Refreshed';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-success');
      } catch (err) {
        console.error('Refresh odds failed:', err);
        btn.textContent = 'Error';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-danger');
      }
    });
  });
});
</script>
{% endblock %}
